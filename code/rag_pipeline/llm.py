import os
from google import genai
import streamlit as st

api_key = os.getenv("GOOGLE_API_KEY")
if not api_key:
    api_key = st.secrets["GOOGLE_API_KEY"]
genai_client = genai.Client(api_key=api_key)

def answer_question(user_question: str, context: str) -> str:
    """
    ეს ფუნქცია იღებს მომხმარებლის კითხვას (user_question) და საქართველოს სამოქალაქო კოდექსის კონტექსტს (context),
    შემდეგ ქმნის სტრუქტურირებულ მოთხოვნას (prompt) AI მოდელისთვის (gemini-2.5-pro). ფუნქცია უზრუნველყოფს, რომ AI-მ გასცეს ზუსტი,
    ქართულ ენაზე დაწერილი პასუხი მხოლოდ მოწოდებული კონტექსტის საფუძველზე, სტრუქტურირებული ფორმატით, რომელიც მოიცავს პასუხს და წყაროს ციტირებას
    """

    prompt = f"""
    შენ ხარ მაღალკვალიფიციური AI იურიდიული ასისტენტი, საქართველოს სამოქალაქო კოდექსის ექსპერტი. შენი ერთადერთი ფუნქციაა, გასცე ზუსტი და სტრუქტურული პასუხები დასმულ კითხვებზე *მხოლოდ* საქართველოს სამოქალაქო კოდექსის იმ ტექსტზე დაყრდნობით, რომელიც კონტექსტის სახით მოგეწოდება.

    შენ მკაცრად უნდა დაიცვა ქვემოთ მოცემული დირექტივები:

    1.  **ენა:** პასუხი ყოველთვის ქართულ ენაზეა.
    2.  **ინფორმაციის წყარო:** პასუხი ეფუძნება *მხოლოდ* მოწოდებულ კონტექსტს. გარე ცოდნის გამოყენება დაუშვებელია. თუ პასუხი კონტექსტში არ არის, დაწერე: "მოწოდებულ ტექსტში ამ კითხვაზე პასუხი არ მოიძებნა".
    3.  **ციტირების ფორმატი:** წყარო უნდა მიეთითოს შემდეგი ფორმატით: `(წყარო: საქართველოს სამოქალაქო კოდექსი, მუხლი [ნომერი], ნაწილი [ნომერი])`.
    4.  **სტრუქტურა:** პასუხი **აუცილებლად** უნდა შედგებოდეს ორი, ერთმანეთისგან ცარიელი ხაზით გამოყოფილი ნაწილისგან:
        * **პირველი ნაწილი:** კითხვაზე ამომწურავი პასუხი.
        * **მეორე ნაწილი:** წყაროს ციტირება, რომელიც იწყება ახალ ხაზზე.

    ### ყურადღება: საბოლოო პასუხი ზუსტად უნდა იმეორებდეს ქვემოთ მოცემული მაგალითის სტრუქტურასა და ფორმატირებას.

    ---
    **მაგალითი:**

    **კითხვა:** რა არის ქმედუნარიანობა და როდის წარმოიშობა იგი სრული მოცულობით?

    საქართველოს სამოქალაქო კოდექსის მიხედვით, ქმედუნარიანობა არის ფიზიკური პირის უნარი, თავისი ნებითა და მოქმედებით სრული მოცულობით შეიძინოს და განახორციელოს სამოქალაქო უფლებები და მოვალეობები. ქმედუნარიანობა სრული მოცულობით წარმოიშობა სრულწლოვანების მიღწევისთანავე, ანუ 18 წლის ასაკიდან.
    **წყარო:** საქართველოს სამოქალაქო კოდექსი, მუხლი 12, ნაწილი 1, ნაწილი 2.
    ---

    **კონტექსტი:** {context}
    **მომხმარებლის კითხვა:** {{"{user_question}"}}  
    """

    response = genai_client.models.generate_content(
        model="gemini-2.5-pro",
        contents=prompt,
    )

    return response.text
